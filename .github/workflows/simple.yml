name: "BedBathBeyond Product Fetcher"

on:
  workflow_dispatch:  # Allows manual triggering from GitHub UI
    inputs:
      option_id:
        description: 'Product Option ID'
        required: true
        default: '90871997'
        type: string
      csv_filename:
        description: 'Output CSV filename'
        required: false
        default: 'product_ids.csv'
        type: string

env:
  API_BASE_URL: "https://api.bedbathandbeyond.com/options"

jobs:
  fetch-product-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml
      
      - name: Create config file
        run: |
          cat > config.yml << 'EOF'
          # Simple configuration
          api_url: "${{ env.API_BASE_URL }}/${{ github.event.inputs.option_id }}"
          output:
            csv_file: "${{ github.event.inputs.csv_filename }}"
            fields: ["ID", "SKU"]
          EOF
      
      - name: Create Python script
        run: |
          cat > fetch_simple.py << 'EOF'
          import yaml
          import requests
          import csv
          import sys
          import os
          
          def load_config():
              """Load configuration from YAML file"""
              with open('config.yml', 'r') as file:
                  return yaml.safe_load(file)
          
          def fetch_data(api_url):
              """Fetch data from API"""
              try:
                  print(f"ðŸ“¡ Fetching data from: {api_url}")
                  response = requests.get(api_url, timeout=10)
                  response.raise_for_status()
                  return response.json()
              except requests.exceptions.RequestException as e:
                  print(f"âŒ Error fetching data: {e}")
                  sys.exit(1)
          
          def save_to_csv(data, filename, fields):
              """Save ID and SKU to CSV file"""
              id_value = data.get('optionId', '')
              sku_value = data.get('modelNumber', '')
              
              # Create CSV file
              with open(filename, 'w', newline='') as csvfile:
                  writer = csv.writer(csvfile)
                  writer.writerow(fields)  # Header
                  writer.writerow([id_value, sku_value])  # Data
              
              print(f"âœ… Data saved to: {filename}")
              print(f"ðŸ“Š ID: {id_value}")
              print(f"ðŸ“Š SKU: {sku_value}")
              
              # Also print full data for debugging
              print(f"ðŸ“¦ Full description: {data.get('description', 'N/A')}")
              print(f"ðŸ’Ž Attributes found: {len(data.get('attributes', []))}")
          
          def main():
              """Main function"""
              print("ðŸš€ Starting BedBathBeyond Product Fetcher")
              
              # Load configuration
              config = load_config()
              
              # Get API URL
              api_url = config.get('api_url', '')
              if not api_url:
                  print("âŒ No API URL found in configuration")
                  sys.exit(1)
              
              # Get output settings
              output = config.get('output', {})
              csv_file = output.get('csv_file', 'output.csv')
              fields = output.get('fields', ['ID', 'SKU'])
              
              # Fetch data
              data = fetch_data(api_url)
              
              # Save to CSV
              save_to_csv(data, csv_file, fields)
              
              print("âœ… Process completed successfully!")
          
          if __name__ == "__main__":
              main()
          EOF
      
      - name: Run data fetcher
        run: python fetch_simple.py
      
      - name: Upload CSV as artifact
        uses: actions/upload-artifact@v4
        with:
          name: product-data
          path: |
            ${{ github.event.inputs.csv_filename }}
          retention-days: 7
      
      - name: Show file contents
        run: |
          echo "ðŸ“„ Contents of generated CSV:"
          cat ${{ github.event.inputs.csv_filename }} || echo "No CSV file generated"